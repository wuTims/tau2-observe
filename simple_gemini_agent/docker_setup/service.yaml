# Cloud Run service definition for simple_gemini_agent
# Deploy with: gcloud run services replace service.yaml --region us-west2
#
# This is a minimal ADK agent for tau2-bench evaluation testing.
#
# Usage:
#   # Build and push the container
#   gcloud builds submit --tag us-west2-docker.pkg.dev/${PROJECT_ID}/tau2-agent/simple-gemini-agent
#
#   # Deploy using this service definition
#   gcloud run services replace service.yaml --region us-west2

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: simple-gemini-agent
  labels:
    app: simple-gemini-agent
  annotations:
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "5"
        run.googleapis.com/execution-environment: gen2
    spec:
      serviceAccountName: tau2-agent-sa@${PROJECT_ID}.iam.gserviceaccount.com
      containerConcurrency: 10
      timeoutSeconds: 300
      containers:
        - image: us-west2-docker.pkg.dev/${PROJECT_ID}/tau2-agent/simple-gemini-agent:latest
          ports:
            - containerPort: 8001
          resources:
            limits:
              memory: 512Mi
              cpu: "1"
          env:
            - name: PORT
              value: "8001"
            - name: SIMPLE_AGENT_MODEL
              value: gemini-2.0-flash
            # GEMINI_API_KEY from Secret Manager (uses google-api-key secret)
            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: google-api-key
                  key: latest
          startupProbe:
            httpGet:
              path: /a2a/simple_gemini_agent/.well-known/agent-card.json
              port: 8001
            initialDelaySeconds: 3
            periodSeconds: 3
            failureThreshold: 10
          livenessProbe:
            httpGet:
              path: /a2a/simple_gemini_agent/.well-known/agent-card.json
              port: 8001
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
